<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canva Master Pro - AI Team Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#FF9FFC', dark: '#D96AD6', glow: 'rgba(255, 159, 252, 0.6)' },
                        dark: { bg: '#0f172a', surface: '#1e293b' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'fade-up': 'fadeUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- Three.js (Stable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: #0f172a; touch-action: none; }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            color: white;
        }
        .glass-input:focus { border-color: #FF9FFC; box-shadow: 0 0 15px rgba(255, 159, 252, 0.2); outline: none; }

        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass-card:hover { transform: translateY(-6px) scale(1.01); background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%); }

        /* Interactive */
        .fav-btn i { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fav-btn:active i { transform: scale(0.8); }
        .fav-btn.active i { color: #FF9FFC; font-weight: fill; transform: scale(1.2); filter: drop-shadow(0 0 8px #FF9FFC); }

        /* AI Chat Rich Text */
        .ai-response { font-size: 0.95em; line-height: 1.6; color: #e2e8f0; }
        .ai-response p { margin-bottom: 8px; }
        .ai-response strong { color: #FF9FFC; font-weight: 700; }
        .ai-response em { font-style: italic; color: #cbd5e1; }
        .ai-response u { text-decoration: underline; text-decoration-color: #FF9FFC; text-underline-offset: 4px; }
        .ai-response ul { list-style: none; padding-left: 0; margin: 8px 0; }
        .ai-response ul li { position: relative; padding-left: 20px; margin-bottom: 4px; }
        .ai-response ul li::before { content: "â€¢"; color: #FF9FFC; position: absolute; left: 0; font-weight: bold; }
        .ai-response ol { list-style: none; counter-reset: item; padding-left: 0; margin: 8px 0; }
        .ai-response ol li { counter-increment: item; margin-bottom: 4px; display: flex; gap: 8px; }
        .ai-response ol li::before { content: counter(item) "."; color: #FF9FFC; font-weight: bold; }
        .ai-response a { color: #FF9FFC; text-decoration: none; border-bottom: 1px dotted #FF9FFC; transition: 0.2s; }
        .ai-response a:hover { border-bottom: 1px solid #FF9FFC; background: rgba(255,159,252,0.1); }
        .ai-response code { background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: #FF9FFC; }

        .chat-dots span { animation: bounce 1.4s infinite ease-in-out both; display: inline-block; margin: 0 1px; width: 4px; height: 4px; border-radius: 50%; background-color: currentColor; }
        .chat-dots span:nth-child(1) { animation-delay: -0.32s; }
        .chat-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 antialiased selection:bg-brand selection:text-white">

    <div id="canvas-container"></div>

    <!-- Modals -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300"></div>
    <div id="edit-modal-container" class="hidden fixed inset-0 z-[101] bg-black/80 backdrop-blur-md flex items-center justify-center p-4"></div>

    <!-- Main App -->
    <div id="app" class="h-full flex flex-col relative overflow-hidden opacity-0 transition-opacity duration-700">
        
        <!-- Navbar -->
        <header class="h-14 md:h-16 glass-panel border-b border-white/5 flex items-center justify-between px-4 md:px-6 shrink-0 z-50">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-tr from-brand to-purple-600 flex items-center justify-center text-white font-bold shadow-[0_0_20px_rgba(255,159,252,0.3)] animate-float">
                    <i class="ph-bold ph-crown-simple text-lg"></i>
                </div>
                <div><h1 class="font-bold text-base md:text-lg text-white leading-none tracking-tight">Canva Master <span class="text-brand drop-shadow-md">Pro</span></h1></div>
            </div>
            <nav class="flex items-center gap-2">
                <button onclick="App.switchView('user')" id="nav-user" class="px-4 py-2 rounded-xl text-xs md:text-sm font-semibold transition-all hover:bg-white/5 text-brand shadow-inner">Teams</button>
                <button onclick="App.switchView('admin-check')" id="nav-admin" class="relative px-4 py-2 rounded-xl text-xs md:text-sm font-semibold transition-all hover:bg-white/5 text-slate-400">
                    Admin <span id="admin-badge" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse border border-black"></span>
                </button>
            </nav>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 relative overflow-hidden overflow-y-auto"></main>

        <!-- Toast Notifications -->
        <div id="toast-container" class="fixed top-20 right-4 z-[90] flex flex-col gap-3 pointer-events-none"></div>

        <!-- Chat Buttons -->
        <div id="user-chat-dock" class="hidden absolute bottom-6 right-6 z-40">
            <button onclick="Chat.toggle('user')" class="w-14 h-14 rounded-full bg-gradient-to-br from-brand to-purple-600 text-white shadow-lg flex items-center justify-center hover:scale-110 transition-transform animate-float"><i class="ph-fill ph-sparkle text-2xl"></i></button>
        </div>
        <div id="admin-chat-dock" class="hidden absolute bottom-6 right-6 z-40">
            <button onclick="Chat.toggle('admin')" class="w-14 h-14 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center hover:scale-110 transition-transform"><i class="ph-fill ph-magic-wand text-2xl"></i></button>
        </div>

        <!-- Chat Window: User -->
        <div id="chat-window-user" class="hidden fixed bottom-24 right-4 w-[calc(100vw-32px)] md:w-96 h-[500px] max-h-[60vh] glass-panel rounded-2xl shadow-2xl flex flex-col z-50 border border-brand/20 backdrop-blur-2xl transition-all origin-bottom-right">
            <div class="p-3 border-b border-white/5 flex justify-between items-center bg-brand/5 rounded-t-2xl">
                <span class="text-sm font-bold text-brand flex items-center gap-2"><i class="ph-fill ph-robot"></i> AI Assistant</span>
                <button onclick="Chat.close('user')" class="text-slate-400 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="chat-messages-user" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm scroll-smooth"></div>
            <div class="p-3 border-t border-white/5 bg-black/20 rounded-b-2xl"><form onsubmit="Chat.send(event, 'user')" class="flex gap-2"><input type="text" placeholder="I need a link for..." class="flex-1 bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs focus:outline-none focus:border-brand/50 text-white"><button type="submit" class="p-2 bg-brand/20 hover:bg-brand/30 rounded-xl text-brand"><i class="ph-bold ph-paper-plane-right"></i></button></form></div>
        </div>

        <!-- Chat Window: Admin -->
        <div id="chat-window-admin" class="hidden fixed bottom-24 right-4 w-[calc(100vw-32px)] md:w-96 h-[500px] max-h-[60vh] glass-panel rounded-2xl shadow-2xl flex flex-col z-50 border border-indigo-500/30 backdrop-blur-2xl">
            <div class="p-3 border-b border-white/5 flex justify-between items-center bg-indigo-500/10 rounded-t-2xl">
                <span class="text-sm font-bold text-indigo-300 flex items-center gap-2"><i class="ph-fill ph-brain"></i> Admin AI</span>
                <button onclick="Chat.close('admin')" class="text-slate-400 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="chat-messages-admin" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm scroll-smooth"></div>
            <div class="p-3 border-t border-white/5 bg-black/20 rounded-b-2xl"><form onsubmit="Chat.send(event, 'admin')" class="flex gap-2"><input type="text" placeholder="CMD: create link..." class="flex-1 bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs focus:outline-none focus:border-indigo-500/50 text-white"><button type="submit" class="p-3 bg-indigo-600/20 hover:bg-indigo-600/30 rounded-xl text-indigo-300"><i class="ph-bold ph-paper-plane-right"></i></button></form></div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        /* --- 1. GENIUS AI ENGINE --- */
        class SmartAIEngine {
            constructor() {
                this.kb = {
                    general: [
                        { q: ['price', 'cost', 'pay', 'money'], a: "Canva Pro is normally paid, but with our **Team Links**, you join for __FREE__! No credit card required." },
                        { q: ['safe', 'legit', 'scam', 'real'], a: "Yes! These are official **Canva Invite Links**. \n- No passwords shared\n- Direct access\n- 100% Safe" },
                        { q: ['limit', 'full', '500'], a: "Canva teams have a 500 member limit. If a link is red/full, please wait for the admin to add a new one." },
                        { q: ['features', 'benefit'], a: "You get:\n- 100M+ Premium Photos\n- Magic Resize\n- Background Remover\n- Brand Kits\n- 1TB Storage" }
                    ]
                };
            }

            parseMarkdown(text) {
                let html = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/__(.*?)__/g, '<u>$1</u>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/\n/g, '<br>');

                // List parsing
                if (html.includes('- ')) {
                    html = html.replace(/- (.*?)(<br>|$)/g, '<ul><li>$1</li></ul>');
                    html = html.replace(/<\/ul><ul>/g, ''); // Merge lists
                }
                if (html.includes('1. ')) {
                    html = html.replace(/\d+\. (.*?)(<br>|$)/g, '<ol><li>$1</li></ol>');
                    html = html.replace(/<\/ol><ol>/g, ''); // Merge lists
                }

                return html;
            }

            async processUserQuery(q, links) {
                const query = q.toLowerCase();
                
                // 1. Data Integration: Link Finding
                if (query.includes('link') || query.includes('give') || query.includes('fresh')) {
                    const matched = links.filter(l => l.status === 'Active' && l.joinedCount < l.totalSeats);
                    
                    if (matched.length > 0) {
                        // Smart Sort: Prioritize Education or least full
                        const best = matched.sort((a,b) => a.joinedCount - b.joinedCount)[0];
                        return this.parseMarkdown(`ðŸŽ‰ I found a fresh link for you!\n\n**${best.title}**\n- Category: ${best.category}\n- Seats: ${best.joinedCount}/${best.totalSeats}\n\n[Click Here to Join Now](${best.url})`);
                    }
                    return this.parseMarkdown("âš ï¸ **Status Update:**\nAll current links are **FULL**. Please check back later!");
                }

                // 2. Data Integration: Statistics
                if (query.includes('how many') || query.includes('count')) {
                    const active = links.filter(l => l.status === 'Active').length;
                    return this.parseMarkdown(`We currently have **${active} active teams** available for you to join.`);
                }

                // 3. Knowledge Base (Internet Sim)
                for (let item of this.kb.general) {
                    if (item.q.some(k => query.includes(k))) return this.parseMarkdown(item.a);
                }

                return this.parseMarkdown("I can help you find **Education** or **Enterprise** links. Try asking:\n- *Give me a link*\n- *Is this safe?*\n- *How many links are there?*");
            }

            async processAdminQuery(q) {
                const query = q.toLowerCase();
                
                // Automation: Create Link
                if (query.startsWith("create link")) {
                    try {
                        const title = query.match(/title=['"](.*?)['"]/)[1];
                        const url = query.match(/url=['"](.*?)['"]/)[1];
                        Store.addLink({title, url, category: "AI Generated", totalSeats: 500});
                        return this.parseMarkdown(`âœ… **Success!**\nLink "**${title}**" created successfully.`);
                    } catch(e) { return "Error format: `create link title='Name' url='http...'`"; }
                }

                // Automation: Clear Chat
                if (query.includes('clear chat')) {
                    Store.adminChat = [];
                    localStorage.setItem('cmp_chat_admin', JSON.stringify([]));
                    return ""; // handled by UI refresh
                }

                // Automation: Report
                if (query.includes('report') || query.includes('stats')) {
                    const total = Store.links.length;
                    const full = Store.links.filter(l => l.joinedCount >= l.totalSeats).length;
                    return this.parseMarkdown(`ðŸ“Š **System Report**\n- Total Links: **${total}**\n- Full Links: **${full}**\n- Notifications: **${Store.notifications.length}**`);
                }

                return this.parseMarkdown("I am your Admin Assistant. Commands:\n1. `create link title='...' url='...'`\n2. `give me a report`\n3. `clear chat`");
            }
        }
        const AI = new SmartAIEngine();

        /* --- 2. DATA STORE --- */
        const Store = {
            links: [], favorites: [], notifications: [], userChat: [], adminChat: [], session: false, stats: { dailyClicks: [0,0,0,0,0,0,0] }, 
            config: { password: 'Admin$123', apiKey: '' },
            init() {
                this.links = JSON.parse(localStorage.getItem('cmp_links')) || [];
                this.favorites = JSON.parse(localStorage.getItem('cmp_favs')) || [];
                this.notifications = JSON.parse(localStorage.getItem('cmp_notifs')) || [];
                this.userChat = JSON.parse(localStorage.getItem('cmp_chat_user')) || [];
                this.adminChat = JSON.parse(localStorage.getItem('cmp_chat_admin')) || [];
                this.session = localStorage.getItem('cmp_session') === 'true';
                this.stats = JSON.parse(localStorage.getItem('cmp_stats')) || { dailyClicks: [0, 0, 0, 0, 0, 0, 0] };
                this.config = JSON.parse(localStorage.getItem('cmp_config')) || this.config;
            },
            save() { 
                localStorage.setItem('cmp_links', JSON.stringify(this.links)); 
                localStorage.setItem('cmp_notifs', JSON.stringify(this.notifications)); 
                localStorage.setItem('cmp_favs', JSON.stringify(this.favorites)); 
                localStorage.setItem('cmp_stats', JSON.stringify(this.stats));
                localStorage.setItem('cmp_config', JSON.stringify(this.config));
                localStorage.setItem('cmp_chat_user', JSON.stringify(this.userChat));
                localStorage.setItem('cmp_chat_admin', JSON.stringify(this.adminChat));
            },
            setSession(val) { this.session = val; localStorage.setItem('cmp_session', val); },
            addLink(l) { l.id = Date.now().toString(36); l.joinedCount=0; l.status='Active'; this.links.unshift(l); this.save(); App.render(); },
            updateLink(id, data) { const idx = this.links.findIndex(l => l.id===id); if(idx!==-1) { this.links[idx]={...this.links[idx], ...data}; this.save(); App.render(); } },
            updateConfig(key, val) { this.config[key] = val; this.save(); },
            checkJoin(id) {
                const l = this.links.find(x => x.id === id);
                if (!l || l.joinedCount >= l.totalSeats) return false;
                l.joinedCount++;
                this.stats.dailyClicks[this.stats.dailyClicks.length-1]++;
                if (l.joinedCount >= l.totalSeats) { this.notifications.push({msg: `Link "${l.title}" is FULL.`}); this.save(); App.updateBadge(); }
                this.save(); return true;
            },
            toggleFavorite(id) { if(this.favorites.includes(id)) this.favorites = this.favorites.filter(x => x !== id); else this.favorites.push(id); this.save(); App.render(); },
            deleteLink(id) { this.links = this.links.filter(l => l.id !== id); this.save(); },
            toggleStatus(id) { const l = this.links.find(x => x.id === id); if(l) l.status = l.status==='Active'?'Hidden':'Active'; this.save(); },
            resetData() { localStorage.clear(); location.reload(); },
            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({links: this.links, stats: this.stats, config: this.config}));
                const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", "backup.json"); document.body.appendChild(node); node.click(); node.remove();
            }
        };

        /* --- 3. UI LOGIC --- */
        const UI = {
            toast(msg, type='info') {
                const c = document.getElementById('toast-container'); const d = document.createElement('div');
                d.className = `glass-panel px-4 py-3 rounded-xl border-l-4 ${type==='success'?'border-green-500 text-green-400':type==='danger'?'border-red-500 text-red-400':'border-brand text-brand'} shadow-xl text-xs font-bold flex items-center gap-3 fade-in`;
                d.innerHTML = `<span>${msg}</span>`; c.appendChild(d); setTimeout(()=>d.remove(), 3500);
            },
            modal(cfg) {
                const el = document.getElementById('modal-overlay');
                el.innerHTML = `
                    <div class="glass-panel p-6 rounded-2xl w-[85vw] max-w-sm border border-white/10 shadow-2xl animate-fade-up">
                        <h3 class="text-xl font-bold text-white mb-2">${cfg.title}</h3><p class="text-slate-400 text-sm mb-6">${cfg.message}</p>
                        <div class="flex gap-3 w-full"><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="flex-1 py-2 rounded-lg bg-white/5 text-white text-sm">Cancel</button>${cfg.confirmText ? `<button id="modal-confirm" class="flex-1 py-2 rounded-lg ${cfg.type==='danger'?'bg-red-500':'bg-brand'} text-white text-sm font-bold">${cfg.confirmText}</button>` : ''}</div>
                    </div>`;
                el.classList.remove('hidden');
                if(cfg.confirmText) document.getElementById('modal-confirm').onclick = () => { cfg.onConfirm(); el.classList.add('hidden'); };
            },
            editModal(id) {
                const l = Store.links.find(x => x.id === id);
                const el = document.getElementById('edit-modal-container');
                el.innerHTML = `
                    <div class="glass-panel p-6 rounded-2xl w-full max-w-md border border-brand/30 shadow-2xl animate-fade-up">
                        <h3 class="text-xl font-bold text-white mb-4">Edit Link</h3>
                        <form onsubmit="App.handleEdit(event, '${id}')" class="grid grid-cols-2 gap-3">
                            <input type="text" name="title" value="${l.title}" class="col-span-2 glass-input rounded-lg px-3 py-2 text-sm text-white" placeholder="Title">
                            <input type="url" name="url" value="${l.url}" class="col-span-2 glass-input rounded-lg px-3 py-2 text-sm text-white" placeholder="URL">
                            <input type="number" name="seats" value="${l.totalSeats}" class="glass-input rounded-lg px-3 py-2 text-sm text-white" placeholder="Seats">
                            <select name="category" class="glass-input rounded-lg px-3 py-2 text-sm text-slate-300"><option ${l.category==='Education Team'?'selected':''}>Education Team</option><option ${l.category==='Enterprise Team'?'selected':''}>Enterprise Team</option></select>
                            <input type="text" name="image" value="${l.image||''}" class="col-span-2 glass-input rounded-lg px-3 py-2 text-sm text-white" placeholder="Image URL">
                            <div class="col-span-2 flex gap-2 mt-2"><button type="button" onclick="document.getElementById('edit-modal-container').classList.add('hidden')" class="flex-1 py-2 bg-white/10 rounded-lg text-white text-sm">Cancel</button><button type="submit" class="flex-1 py-2 bg-brand rounded-lg text-white text-sm font-bold">Save</button></div>
                        </form>
                    </div>`;
                el.classList.remove('hidden');
            },
            renderChart() {
                const data = Store.stats.dailyClicks; 
                const max = Math.max(...data) + 5; 
                const points = data.map((v, i) => { const x = (i/(data.length-1))*100; const y = 100 - (v/max)*90; return `${x},${y}`; }).join(' ');
                
                return `
                    <div class="chart-container w-full h-40 relative mt-4 border border-white/5 bg-black/20 rounded-xl p-4 overflow-hidden">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" style="width:100%; height:100%;">
                            <defs><linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#FF9FFC" stop-opacity="0.3"/><stop offset="100%" stop-color="#FF9FFC" stop-opacity="0"/></linearGradient></defs>
                            <line x1="0" y1="25" x2="100" y2="25" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/><line x1="0" y1="50" x2="100" y2="50" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/><line x1="0" y1="75" x2="100" y2="75" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/>
                            <polygon points="0,100 ${points} 100,100" fill="url(#chartGradient)" />
                            <polyline points="${points}" fill="none" stroke="#FF9FFC" stroke-width="2" class="chart-line" vector-effect="non-scaling-stroke"/>
                            ${data.map((v, i) => `<circle cx="${(i/(data.length-1))*100}" cy="${100-(v/max)*90}" r="3" class="chart-dot"><title>${v} Clicks</title></circle>`).join('')}
                        </svg>
                    </div>
                `;
            }
        };

        const App = {
            view: 'user', adminView: 'dashboard', userSearch: '', adminSearch: '',
            init() { 
                Store.init(); 
                const lastView = localStorage.getItem('cmp_last_view'); 
                if(Store.session && lastView && lastView.includes('admin')) this.view = 'admin-dashboard'; 
                else this.view = 'user'; 
                document.getElementById('app').style.opacity = '1'; 
                App.render(); App.updateBadge(); requestAnimationFrame(init3D); 
            },
            switchView(v) { 
                if (v === 'user') Chat.close('admin');
                if (v === 'admin-check' || v === 'admin-dashboard') Chat.close('user');
                if(v === 'admin-check') { if(Store.session) this.view = 'admin-dashboard'; else this.view = 'admin-login'; } 
                else { this.view = v; } 
                localStorage.setItem('cmp_last_view', this.view); this.render(); 
            },
            switchAdmin(v) { this.adminView = v; this.render(); },
            updateBadge() { const el = document.getElementById('admin-badge'); Store.notifications.length>0 ? el.classList.remove('hidden') : el.classList.add('hidden'); },
            handleJoinClick(e, id) { if (!Store.checkJoin(id)) { e.preventDefault(); UI.modal({ title: 'Full', message: 'Team limit reached.', type: 'danger' }); return false; } App.render(); return true; },
            handleEdit(e, id) { e.preventDefault(); const f = e.target; Store.updateLink(id, { title: f.title.value, url: f.url.value, totalSeats: parseInt(f.seats.value), category: f.category.value, image: f.image.value }); document.getElementById('edit-modal-container').classList.add('hidden'); UI.toast('Updated', 'success'); },
            toggleInput(id, btnId) { const inp = document.getElementById(id); const icon = document.getElementById(btnId); if (inp.type === 'password') { inp.type = 'text'; icon.classList.replace('ph-eye', 'ph-eye-slash'); } else { inp.type = 'password'; icon.classList.replace('ph-eye-slash', 'ph-eye'); } },
            handleChangePassword(e) {
                e.preventDefault(); const f = e.target; const curr = f.currentPass.value; const newP = f.newPass.value; const confP = f.confirmPass.value;
                if(curr !== Store.config.password) { UI.toast('Current incorrect', 'danger'); return; }
                if(newP !== confP) { UI.toast('Mismatch', 'danger'); return; }
                if(newP.length < 4) { UI.toast('Too short', 'danger'); return; }
                Store.updateConfig('password', newP); UI.toast('Password Updated', 'success'); f.reset();
            },
            handleLogin(e) { e.preventDefault(); if(e.target.p.value === Store.config.password) { Store.setSession(true); App.switchView('admin-dashboard'); UI.toast('Welcome Admin', 'success'); } else { UI.toast('Invalid Password', 'danger'); } },
            handleAdd(e) { e.preventDefault(); const f=e.target; Store.addLink({title:f.title.value, url:f.url.value, category:f.cat.value, totalSeats:parseInt(f.seats.value), image: f.url_img.value}); UI.toast('Published','success'); App.render(); f.reset(); document.getElementById('img-preview').style.backgroundImage=''; },
            
            handleSEOSettings(e) { e.preventDefault(); const f = e.target; Store.updateConfig('metaDesc', f.mDesc.value); Store.updateConfig('keywords', f.mKeys.value); UI.toast('SEO Config Saved', 'success'); },
            handleSearch(val, type) { if(type === 'user') this.userSearch = val.toLowerCase(); else this.adminSearch = val.toLowerCase(); this.render(); },
            handleAPIKey(e) { e.preventDefault(); Store.updateConfig('apiKey', e.target.key.value); UI.toast('API Key Saved (Simulated)', 'success'); },
            
            previewImage(input) { const val = input.value; document.getElementById('img-preview').style.backgroundImage = val ? `url('${val}')` : 'none'; },
            handleImageUpload(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_W = 500; const scale = MAX_W / img.width; canvas.width = MAX_W; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const compressed = canvas.toDataURL('image/jpeg', 0.8); document.querySelector('input[name="url_img"]').value = compressed; App.previewImage(document.querySelector('input[name="url_img"]')); UI.toast('Image Optimized', 'success'); }; img.src = e.target.result; }; reader.readAsDataURL(file); } },

            render() {
                const main = document.getElementById('main-content');
                document.getElementById('user-chat-dock').style.display = this.view==='user'?'block':'none';
                document.getElementById('admin-chat-dock').style.display = this.view==='admin-dashboard'?'block':'none';
                document.getElementById('nav-user').className = this.view==='user' ? 'px-3 py-1.5 rounded-lg text-xs bg-brand/20 text-brand font-bold shadow-inner' : 'px-3 py-1.5 rounded-lg text-xs hover:bg-white/5 text-slate-400';
                document.getElementById('nav-admin').className = this.view.includes('admin') ? 'relative px-3 py-1.5 rounded-lg text-xs bg-brand/20 text-brand font-bold shadow-inner' : 'relative px-3 py-1.5 rounded-lg text-xs hover:bg-white/5 text-slate-400';
                main.innerHTML = '';
                if(this.view === 'user') this.renderUser(main);
                else if(this.view === 'admin-login') this.renderLogin(main);
                else if(this.view === 'admin-dashboard') this.renderAdmin(main);
            },

            renderUser(c) {
                let links = Store.links.filter(l => l.status === 'Active');
                if(this.userSearch) links = links.filter(l => l.title.toLowerCase().includes(this.userSearch) || l.category.toLowerCase().includes(this.userSearch));
                
                c.innerHTML = `
                    <div class="h-full overflow-y-auto p-4 md:p-8 fade-in pb-24">
                        <div class="max-w-7xl mx-auto">
                            <div class="text-center mb-8 mt-4 animate-fade-up">
                                <h2 class="text-2xl md:text-5xl font-bold text-white mb-2 tracking-tight">Join <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand to-purple-400">Pro Teams</span></h2>
                                <p class="text-slate-400 text-xs md:text-sm max-w-xl mx-auto mb-6">Real-time slot tracking. Instant access.</p>
                                <div class="relative max-w-md mx-auto mb-8"><i class="ph-bold ph-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i><input type="text" oninput="App.handleSearch(this.value, 'user')" placeholder="Search teams..." class="w-full glass-input rounded-xl pl-11 pr-4 py-3 text-sm text-white transition-all focus:bg-white/10" value="${this.userSearch}"></div>
                            </div>
                            ${links.length === 0 ? `<div class="text-center py-10"><div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-500"><i class="ph-fill ph-ghost text-3xl"></i></div><p class="text-slate-400 text-sm">No links found.</p></div>` : `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">${links.map((l, idx) => this.card(l, idx)).join('')}</div>`}
                        </div>
                    </div>`;
            },

            card(l, idx) {
                const isFull = l.joinedCount >= l.totalSeats;
                const pct = (l.joinedCount / l.totalSeats) * 100;
                const isFav = Store.favorites.includes(l.id);
                const bg = l.image ? `background-image: url('${l.image}'); background-size: cover;` : `background: linear-gradient(135deg, #1e293b, #0f172a);`;
                const borderClass = isFull ? 'border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.2)]' : 'border-brand/30 hover:border-brand shadow-[0_0_15px_rgba(255,159,252,0.1)]';
                const btnClass = isFull ? 'bg-gradient-to-r from-red-500 to-red-600 text-white cursor-not-allowed opacity-80' : 'bg-gradient-to-r from-emerald-400 to-emerald-600 text-white hover:from-emerald-300 hover:to-emerald-500 shadow-lg shadow-emerald-500/30';
                
                return `
                <div class="glass-card rounded-2xl overflow-hidden group flex flex-col relative ${isFull ? 'grayscale-[0.8]' : ''} ${borderClass} animate-fade-up stagger-${idx%3+1}" style="animation-delay: ${idx*0.1}s">
                    <div class="h-32 md:h-44 relative flex items-center justify-center bg-cover bg-center" style="${bg}">
                        <div class="absolute inset-0 bg-black/40 transition-colors group-hover:bg-black/20"></div>
                        <div class="absolute top-2 right-2 z-10"><button onclick="Store.toggleFavorite('${l.id}')" class="fav-btn ${isFav?'active':''} w-10 h-10 flex items-center justify-center transition-transform hover:scale-110"><i class="ph${isFav?'-fill':'-bold'} ph-heart text-2xl ${isFav?'text-[#FF9FFC] drop-shadow-[0_0_10px_#FF9FFC]':'text-white'}"></i></button></div>
                        <div class="absolute bottom-2 left-2 z-10"><span class="px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-white/10 backdrop-blur-md border border-white/20 text-white shadow-lg flex items-center gap-1"><i class="ph-fill ph-tag"></i> ${l.category}</span></div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col bg-gradient-to-b from-transparent to-black/30">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-white text-lg truncate flex-1 tracking-tight">${l.title}</h3>${isFull ? '<span class="text-[9px] bg-red-500 px-2 py-1 rounded-md text-white font-bold shadow-red-500/50 shadow-sm">FULL</span>' : '<span class="text-[9px] bg-emerald-500 px-2 py-1 rounded-md text-white font-bold shadow-emerald-500/50 shadow-sm animate-pulse-slow">LIVE</span>'}</div>
                        <div class="mb-4"><div class="flex justify-between text-[10px] text-slate-300 mb-1 font-medium"><span>Capacity</span><span class="${isFull ? 'text-red-400' : 'text-emerald-400'}">${l.joinedCount}/${l.totalSeats}</span></div><div class="h-1.5 w-full bg-black/40 rounded-full overflow-hidden border border-white/10"><div class="h-full ${isFull ? 'bg-red-500' : 'bg-gradient-to-r from-brand to-purple-500'} transition-all duration-700 ease-out" style="width: ${pct}%"></div></div></div>
                        <a href="${l.url}" target="_blank" onclick="return App.handleJoinClick(event, '${l.id}')" class="${btnClass} w-full py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 decoration-none mt-auto transition-all transform active:scale-95">
                            ${isFull ? '<i class="ph-bold ph-lock-key"></i> Team Full' : '<i class="ph-bold ph-users-three"></i> Join Team Now'}
                        </a>
                    </div>
                </div>`;
            },

            renderAdmin(c) {
                c.innerHTML = `
                    <div class="h-full flex flex-col md:flex-row fade-in">
                        <aside class="w-full md:w-64 glass-panel border-r border-white/10 flex md:flex-col justify-around p-4 shrink-0">
                            <div class="hidden md:block mb-6"><h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Dashboard</h2></div>
                            <nav class="flex md:flex-col gap-2 w-full overflow-x-auto">
                                <button onclick="App.switchAdmin('dashboard')" class="flex-shrink-0 flex-1 md:flex-none text-left px-4 py-3 rounded-xl ${this.adminView==='dashboard'?'bg-brand/10 text-brand border border-brand/20':'text-slate-400 hover:bg-white/5'} text-xs font-bold flex items-center gap-2"><i class="ph-bold ph-squares-four text-lg"></i> <span>Overview</span></button>
                                <button onclick="App.switchAdmin('analytics')" class="flex-shrink-0 flex-1 md:flex-none text-left px-4 py-3 rounded-xl ${this.adminView==='analytics'?'bg-brand/10 text-brand border border-brand/20':'text-slate-400 hover:bg-white/5'} text-xs font-bold flex items-center gap-2"><i class="ph-bold ph-chart-line-up text-lg"></i> <span>Analytics</span></button>
                                <button onclick="App.switchAdmin('settings')" class="flex-shrink-0 flex-1 md:flex-none text-left px-4 py-3 rounded-xl ${this.adminView==='settings'?'bg-brand/10 text-brand border border-brand/20':'text-slate-400 hover:bg-white/5'} text-xs font-bold flex items-center gap-2"><i class="ph-bold ph-gear text-lg"></i> <span>Settings</span></button>
                            </nav>
                        </aside>
                        <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-24">${this.adminView === 'dashboard' ? this.renderAdminDash() : this.adminView === 'analytics' ? this.renderAnalytics() : this.renderAdminSettings()}</div>
                    </div>`;
            },

            renderAnalytics() {
                const total = Store.stats.dailyClicks.reduce((a,b)=>a+b,0);
                return `
                    <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                        <div class="flex justify-between items-end mb-4">
                            <div><h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph-fill ph-chart-line-up text-brand"></i> Traffic Analysis</h3><p class="text-xs text-slate-400">7-Day Performance</p></div>
                            <div class="text-right"><span class="text-2xl font-bold text-brand">${total}</span><p class="text-[10px] text-slate-500 uppercase">Total Clicks</p></div>
                        </div>
                        ${UI.renderChart()}
                    </div>`;
            },

            renderAdminDash() {
                let dashLinks = Store.links;
                if(this.adminSearch) dashLinks = dashLinks.filter(l => l.title.toLowerCase().includes(this.adminSearch));

                return `
                    <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-plus-circle text-brand"></i> Publish Link</h3>
                        <form onsubmit="App.handleAdd(event)" class="grid grid-cols-2 gap-3">
                            <input type="url" name="url" required placeholder="URL" class="col-span-2 glass-input rounded-lg px-4 py-2 text-xs text-white">
                            <input type="text" name="title" required placeholder="Title" class="glass-input rounded-lg px-4 py-2 text-xs text-white">
                            <input type="number" name="seats" required placeholder="Seats" class="glass-input rounded-lg px-4 py-2 text-xs text-white">
                            <select name="cat" class="col-span-2 glass-input rounded-lg px-4 py-2 text-xs text-slate-300"><option>Education Team</option><option>Enterprise Team</option></select>
                            <input type="text" name="url_img" placeholder="Image URL (Optional)" class="col-span-2 glass-input rounded-lg px-4 py-2 text-xs text-white">
                            <div class="col-span-2 flex gap-3 items-center"><div id="img-preview" class="w-10 h-10 rounded bg-white/5 border border-white/10 bg-cover bg-center"></div><label class="cursor-pointer bg-white/10 hover:bg-white/20 p-2 rounded text-white border border-white/10"><i class="ph-bold ph-upload-simple"></i><input type="file" class="hidden" accept="image/*" onchange="App.handleImageUpload(this)"></label></div>
                            <button type="submit" class="col-span-2 bg-brand hover:bg-brand-dark text-white font-bold rounded-lg py-2.5 text-xs">Publish</button>
                        </form>
                    </div>
                    
                    <div class="relative mb-4">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" oninput="App.handleSearch(this.value, 'admin')" placeholder="Search active links..." class="w-full glass-input rounded-lg pl-10 pr-4 py-2 text-xs text-white" value="${this.adminSearch}">
                    </div>

                    <div class="glass-panel rounded-xl border border-white/10 overflow-x-auto">
                        <table class="w-full text-left text-xs text-slate-400 min-w-[300px]">
                            <thead class="bg-white/5 text-slate-200"><tr><th class="p-4">Title</th><th class="p-4">Seats</th><th class="p-4 text-right">Action</th></tr></thead>
                            <tbody class="divide-y divide-white/5">${dashLinks.map(l => `<tr class="hover:bg-white/5"><td class="p-4 text-white font-bold truncate max-w-[100px]">${l.title}</td><td class="p-4">${l.joinedCount}/${l.totalSeats}</td><td class="p-4 text-right flex justify-end gap-2"><button onclick="UI.editModal('${l.id}')" class="text-brand p-1.5 hover:bg-white/10 rounded"><i class="ph-bold ph-pencil-simple text-lg"></i></button><button onclick="UI.modal({title:'Delete?', message:'Sure?', type:'danger', confirmText:'Delete', onConfirm:()=>{Store.deleteLink('${l.id}'); App.render();}})" class="text-red-400 p-1.5 hover:bg-red-500/10 rounded"><i class="ph-bold ph-trash text-lg"></i></button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>`;
            },

            renderAdminSettings() {
                return `
                    <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-lock-key text-brand"></i> Security</h3>
                        <form onsubmit="App.handleChangePassword(event)" class="space-y-3">
                            <div class="relative"><input type="password" id="current-pass" name="currentPass" placeholder="Current" class="w-full glass-input rounded-lg px-3 py-2 text-xs"><button type="button" onclick="App.toggleInput('current-pass','curr-eye')" class="absolute right-3 top-2 text-slate-400"><i id="curr-eye" class="ph-eye"></i></button></div>
                            <div class="relative"><input type="password" id="new-pass" name="newPass" placeholder="New" class="w-full glass-input rounded-lg px-3 py-2 text-xs"><button type="button" onclick="App.toggleInput('new-pass','new-eye')" class="absolute right-3 top-2 text-slate-400"><i id="new-eye" class="ph-eye"></i></button></div>
                            <div class="relative"><input type="password" id="confirm-pass" name="confirmPass" placeholder="Confirm" class="w-full glass-input rounded-lg px-3 py-2 text-xs"><button type="button" onclick="App.toggleInput('confirm-pass','conf-eye')" class="absolute right-3 top-2 text-slate-400"><i id="conf-eye" class="ph-eye"></i></button></div>
                            <button type="submit" class="w-full bg-brand text-white font-bold rounded-lg py-2 text-xs mt-2">Update</button>
                        </form>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-robot text-brand"></i> AI Integration</h3>
                        <form onsubmit="App.handleAPIKey(event)" class="space-y-3">
                            <div><label class="text-[10px] text-slate-400">Bytez/OpenAI API Key</label><input type="password" name="key" value="${Store.config.apiKey||''}" class="w-full glass-input rounded-lg px-3 py-2 text-xs" placeholder="sk-..."></div>
                            <button type="submit" class="w-full bg-brand text-white font-bold rounded-lg py-2 text-xs mt-2">Save Key</button>
                        </form>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border border-white/10 mb-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-globe text-brand"></i> SEO</h3>
                        <form onsubmit="App.handleSEOSettings(event)" class="space-y-3">
                            <div><label class="text-[10px] text-slate-400">Meta Desc</label><input type="text" name="mDesc" value="${Store.config.metaDesc || ''}" class="w-full glass-input rounded-lg px-3 py-2 text-xs"></div>
                            <div><label class="text-[10px] text-slate-400">Keywords</label><input type="text" name="mKeys" value="${Store.config.keywords || ''}" class="w-full glass-input rounded-lg px-3 py-2 text-xs"></div>
                            <button type="submit" class="w-full bg-brand text-white font-bold rounded-lg py-2 text-xs mt-2">Save SEO</button>
                        </form>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border border-white/10">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-database text-brand"></i> Data</h3>
                        <div class="flex gap-2"><button onclick="Store.exportData()" class="flex-1 px-4 py-2 bg-white/5 text-white rounded-lg text-xs font-bold">Export</button><button onclick="UI.modal({title:'Factory Reset?', message:'Wipe all data?', type:'danger', confirmText:'Yes', onConfirm:()=>{Store.resetData();}})" class="flex-1 px-4 py-2 bg-red-500/10 border border-red-500/50 text-red-400 rounded-lg text-xs font-bold">Reset</button></div>
                    </div>`;
            },
            
            renderLogin(c) { 
                c.innerHTML = `
                <div class="h-full flex items-center justify-center p-6">
                    <div class="glass-panel p-8 rounded-2xl w-full max-w-sm text-center">
                        <h2 class="text-xl font-bold text-white mb-4">Admin Access</h2>
                        <form onsubmit="App.handleLogin(event)">
                            <div class="relative mb-4"><input type="password" id="admin-pass" name="p" placeholder="Enter Password" class="w-full glass-input rounded-lg px-4 py-3 text-white text-center tracking-widest pr-10"><button type="button" onclick="App.toggleInput('admin-pass','pass-icon')" class="absolute right-3 top-3 text-slate-400 hover:text-white"><i id="pass-icon" class="ph-bold ph-eye text-lg"></i></button></div>
                            <button type="submit" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 rounded-lg text-sm shadow-lg">Unlock Panel</button>
                        </form>
                    </div>
                </div>`; 
            },
            handleAdd(e) { e.preventDefault(); const f=e.target; Store.addLink({title:f.title.value, url:f.url.value, category:f.cat.value, totalSeats:parseInt(f.seats.value), image: f.url_img.value}); UI.toast('Published','success'); App.render(); f.reset(); document.getElementById('img-preview').style.backgroundImage=''; },
            previewImage(input) { const val = input.value; document.getElementById('img-preview').style.backgroundImage = val ? `url('${val}')` : 'none'; },
            handleImageUpload(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_W = 500; const scale = MAX_W / img.width; canvas.width = MAX_W; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const compressed = canvas.toDataURL('image/jpeg', 0.8); document.querySelector('input[name="url_img"]').value = compressed; App.previewImage(document.querySelector('input[name="url_img"]')); UI.toast('Image Optimized', 'success'); }; img.src = e.target.result; }; reader.readAsDataURL(file); } }
        };

        const Chat = {
            isOpen: false, toggle(p) { const el = document.getElementById(`chat-window-${p}`); this.isOpen = !this.isOpen; el.classList.toggle('hidden', !this.isOpen); if(this.isOpen) this.renderHistory(p); },
            close(p) { this.states = false; document.getElementById(`chat-window-${p}`)?.classList.add('hidden'); },
            renderHistory(p) { const h = p==='admin'?Store.adminChat:Store.userChat; const el = document.getElementById(`chat-messages-${p}`); el.innerHTML = h.map(m => `<div class="mb-4 ${m.role==='user'?'text-right':'text-left'}"><div class="inline-block px-4 py-3 rounded-2xl max-w-[85%] ${m.role==='user'?'bg-brand/20 text-brand border border-brand/20 rounded-tr-sm':'bg-white/10 text-slate-200 border border-white/5 rounded-tl-sm'} ai-response shadow-md">${m.content}</div></div>`).join(''); el.scrollTop = el.scrollHeight; },
            async send(e, p) {
                e.preventDefault(); const inp = e.target.querySelector('input'), txt = inp.value.trim(); if(!txt) return;
                const h = p==='admin'?Store.adminChat:Store.userChat; h.push({role:'user', content:txt}); inp.value=''; this.renderHistory(p);
                const c = document.getElementById(`chat-messages-${p}`), lid = 'ld-'+Date.now();
                c.insertAdjacentHTML('beforeend', `<div id="${lid}" class="mb-4 text-left"><div class="inline-block px-4 py-3 rounded-2xl bg-white/5 border border-white/5 rounded-tl-sm chat-dots"><span></span><span></span><span></span></div></div>`); c.scrollTop = c.scrollHeight;
                await new Promise(r => setTimeout(r, 1000));
                let resp = p === 'user' ? await AI.processUserQuery(txt, Store.links) : await AI.processAdminQuery(txt);
                document.getElementById(lid).remove(); h.push({role:'assistant', content:resp}); this.renderHistory(p);
                localStorage.setItem(`cmp_chat_${p}`, JSON.stringify(h));
            }
        };

        /* --- 4. 3D BACKGROUND (Touch Fix) --- */
        let tAttempts = 0;
        const init3D = () => {
            if (typeof THREE === 'undefined') { if(tAttempts<50) { tAttempts++; setTimeout(init3D, 100); } return; }
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x0f172a, 0.02);
            const camera = new THREE.PerspectiveCamera(35, window.innerWidth/window.innerHeight, 0.1, 100); camera.position.z = 50;
            const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight); container.appendChild(renderer.domElement);
            const geo = new THREE.CylinderGeometry(0.1, 0.1, 0.6, 8);
            const mat = new THREE.MeshBasicMaterial({color: 0xFF9FFC});
            const mesh = new THREE.InstancedMesh(geo, mat, 300); scene.add(mesh);
            const dummy = new THREE.Object3D(), particles = [];
            for(let i=0; i<300; i++) particles.push({ t: Math.random()*100, speed: 0.01+Math.random()/200, mx:(Math.random()-0.5)*100, my:(Math.random()-0.5)*100, mz:(Math.random()-0.5)*20, cx:0, cy:0, cz:0 });
            
            let mouse={x:0,y:0}, vMouse={x:0,y:0}, whX=window.innerWidth/2, whY=window.innerHeight/2;
            const updateMouse = (x, y) => { mouse.x = x - whX; mouse.y = y - whY; };
            document.addEventListener('mousemove', e => updateMouse(e.clientX, e.clientY));
            document.addEventListener('touchmove', e => { if(e.touches.length>0) updateMouse(e.touches[0].clientX, e.touches[0].clientY); }, {passive: true});
            document.addEventListener('touchstart', e => { if(e.touches.length>0) updateMouse(e.touches[0].clientX, e.touches[0].clientY); }, {passive: true});

            const animate = () => {
                requestAnimationFrame(animate);
                vMouse.x += ((mouse.x/whX)*50 - vMouse.x)*0.05; vMouse.y += ((-mouse.y/whY)*50 - vMouse.y)*0.05;
                particles.forEach((p, i) => {
                    p.t += 0.4;
                    const projFactor = 1 - p.cz/50;
                    const ptx = vMouse.x * projFactor, pty = vMouse.y * projFactor;
                    const dx = p.mx - ptx, dy = p.my - pty, dist = Math.sqrt(dx*dx+dy*dy);
                    let tx = p.mx, ty = p.my, tz = p.mz;
                    if(dist < 10) { const ang = Math.atan2(dy, dx), w = Math.sin(p.t*0.4+ang)*1; tx = ptx+(10+w)*Math.cos(ang); ty = pty+(10+w)*Math.sin(ang); tz = p.mz+Math.sin(p.t)*1; }
                    p.cx+=(tx-p.cx)*0.1; p.cy+=(ty-p.cy)*0.1; p.cz+=(tz-p.cz)*0.1;
                    dummy.position.set(p.cx, p.cy, p.cz); dummy.lookAt(ptx, pty, p.cz); dummy.rotateX(Math.PI/2);
                    dummy.scale.setScalar(1+Math.sin(p.t*0.2)*0.2); dummy.updateMatrix(); mesh.setMatrixAt(i, dummy.matrix);
                });
                mesh.instanceMatrix.needsUpdate = true; renderer.render(scene, camera);
            };
            animate();
        };

        window.App = App;
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>